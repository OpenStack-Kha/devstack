
#!/bin/bash
ENABLED_SERVICES=swift
DEST=/opt/stack
SWIFT_DIR=$DEST/swift
FILES=/opt/stack/devstack/files
. /root/devstack/functions 
function is_service_enabled() {
    services=$@
        for service in ${services}; do
                [[ ,${ENABLED_SERVICES}, =~ ,${service}, ]] && return 0
                        [[ ${service} == "nova" && ${ENABLED_SERVICES} =~ "n-" ]] && return 0
                                [[ ${service} == "glance" && ${ENABLED_SERVICES} =~ "g-" ]] && return 0
                                        [[ ${service} == "quantum" && ${ENABLED_SERVICES} =~ "q-" ]] && return 0
                                            done
                                                return 1
                                                }
                                                 
                                                 
                                                 
                                                 # SWIFT
                                                 # -----
                                                 # TODO: implement glance support
                                                 # TODO: add logging to different location.
                                                 
                                                 # By default the location of swift drives and objects is located inside
                                                 # the swift source directory. SWIFT_DATA_DIR variable allow you to redefine
                                                 # this.
                                                 SWIFT_DATA_DIR=${SWIFT_DATA_DIR:-${DEST}/data/swift}
                                                 
                                                 # We are going to have the configuration files inside the source
                                                 # directory, change SWIFT_CONFIG_DIR if you want to adjust that.
                                                 SWIFT_CONFIG_DIR=${SWIFT_CONFIG_DIR:-/etc/swift}
                                                 
                                                 # devstack will create a loop-back disk formatted as XFS to store the
                                                 # swift data. By default the disk size is 1 gigabyte. The variable
                                                 # SWIFT_LOOPBACK_DISK_SIZE specified in bytes allow you to change
                                                 # that.
                                                 SWIFT_LOOPBACK_DISK_SIZE=${SWIFT_LOOPBACK_DISK_SIZE:-100000000}
                                                 
                                                 # The ring uses a configurable number of bits from a pathâ€™s MD5 hash as
                                                 # a partition index that designates a device. The number of bits kept
                                                 # from the hash is known as the partition power, and 2 to the partition
                                                 # power indicates the partition count. Partitioning the full MD5 hash
                                                 # ring allows other parts of the cluster to work in batches of items at
                                                 # once which ends up either more efficient or at least less complex than
                                                 # working with each item separately or the entire cluster all at once.
                                                 # By default we define 9 for the partition count (which mean 512).
                                                 SWIFT_PARTITION_POWER_SIZE=${SWIFT_PARTITION_POWER_SIZE:-9}
                                                 
                                                 # This variable allows you to configure how many replicas you want to be
                                                 # configured for your Swift cluster.  By default the three replicas would need a
                                                 # bit of IO and Memory on a VM you may want to lower that to 1 if you want to do
                                                 # only some quick testing.
                                                 SWIFT_REPLICAS=${SWIFT_REPLICAS:-3}
                                                 
                                                 if is_service_enabled swift; then
                                                     # If we are using swift, we can default the s3 port to swift instead
                                                         # of nova-objectstore
                                                             S3_SERVICE_PORT=${S3_SERVICE_PORT:-8080}
                                                                 # We only ask for Swift Hash if we have enabled swift service.
                                                                     # SWIFT_HASH is a random unique string for a swift cluster that
                                                                         # can never change.
                                                                             read_password SWIFT_HASH "ENTER A RANDOM SWIFT HASH."
                                                                             fi
                                                                             
                                                                             SWIFT_HASH=123
                                                                             if is_service_enabled swift; then
                                                                                 cd $SWIFT_DIR; sudo python setup.py develop
                                                                                 fi
                                                                                 
                                                                                 
                                                                                 # Storage Service
                                                                                 if is_service_enabled swift; then
                                                                                     # Install memcached for swift.
                                                                                         install_package memcached
                                                                                         
                                                                                             # We first do a bit of setup by creating the directories and
                                                                                                 # changing the permissions so we can run it as our user.
                                                                                                 
                                                                                                     USER_GROUP=$(id -g)
                                                                                                         sudo mkdir -p ${SWIFT_DATA_DIR}/drives
                                                                                                             sudo chown -R $USER:${USER_GROUP} ${SWIFT_DATA_DIR}
                                                                                                             
                                                                                                                 # We then create a loopback disk and format it to XFS.
                                                                                                                     # TODO: Reset disks on new pass.
                                                                                                                         if [[ ! -e ${SWIFT_DATA_DIR}/drives/images/swift.img ]]; then
                                                                                                                                 mkdir -p  ${SWIFT_DATA_DIR}/drives/images
                                                                                                                                         sudo touch  ${SWIFT_DATA_DIR}/drives/images/swift.img
                                                                                                                                                 sudo chown $USER: ${SWIFT_DATA_DIR}/drives/images/swift.img
                                                                                                                                                 
                                                                                                                                                         dd if=/dev/zero of=${SWIFT_DATA_DIR}/drives/images/swift.img \
                                                                                                                                                                     bs=1024 count=0 seek=${SWIFT_LOOPBACK_DISK_SIZE}
                                                                                                                                                                             mkfs.xfs -f -i size=1024  ${SWIFT_DATA_DIR}/drives/images/swift.img
                                                                                                                                                                                 fi
                                                                                                                                                                                 
                                                                                                                                                                                     # After the drive being created we mount the disk with a few mount
                                                                                                                                                                                         # options to make it most efficient as possible for swift.
                                                                                                                                                                                             mkdir -p ${SWIFT_DATA_DIR}/drives/sdb1
                                                                                                                                                                                                 if ! egrep -q ${SWIFT_DATA_DIR}/drives/sdb1 /proc/mounts; then
                                                                                                                                                                                                         sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs=8  \
                                                                                                                                                                                                                     ${SWIFT_DATA_DIR}/drives/images/swift.img ${SWIFT_DATA_DIR}/drives/sdb1
                                                                                                                                                                                                                         fi
                                                                                                                                                                                                                         
                                                                                                                                                                                                                             # We then create link to that mounted location so swift would know
                                                                                                                                                                                                                                 # where to go.
                                                                                                                                                                                                                                     for x in $(seq ${SWIFT_REPLICAS}); do
                                                                                                                                                                                                                                             sudo ln -sf ${SWIFT_DATA_DIR}/drives/sdb1/$x ${SWIFT_DATA_DIR}/$x; done
                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                 # We now have to emulate a few different servers into one we
                                                                                                                                                                                                                                                     # create all the directories needed for swift
                                                                                                                                                                                                                                                         for x in $(seq ${SWIFT_REPLICAS}); do
                                                                                                                                                                                                                                                                     drive=${SWIFT_DATA_DIR}/drives/sdb1/${x}
                                                                                                                                                                                                                                                                                 node=${SWIFT_DATA_DIR}/${x}/node
                                                                                                                                                                                                                                                                                             node_device=${node}/sdb1
                                                                                                                                                                                                                                                                                                         [[ -d $node ]] && continue
                                                                                                                                                                                                                                                                                                                     [[ -d $drive ]] && continue
                                                                                                                                                                                                                                                                                                                                 sudo install -o ${USER} -g $USER_GROUP -d $drive
                                                                                                                                                                                                                                                                                                                                             sudo install -o ${USER} -g $USER_GROUP -d $node_device
                                                                                                                                                                                                                                                                                                                                                         sudo chown -R $USER: ${node}
                                                                                                                                                                                                                                                                                                                                                             done
                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                sudo mkdir -p ${SWIFT_CONFIG_DIR}/{object,container,account}-server /var/run/swift
                                                                                                                                                                                                                                                                                                                                                                   sudo chown -R $USER: ${SWIFT_CONFIG_DIR} /var/run/swift
                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                       if [[ "$SWIFT_CONFIG_DIR" != "/etc/swift" ]]; then
                                                                                                                                                                                                                                                                                                                                                                               # Some swift tools are hard-coded to use /etc/swift and are apparenty not going to be fixed.
                                                                                                                                                                                                                                                                                                                                                                                       # Create a symlink if the config dir is moved
                                                                                                                                                                                                                                                                                                                                                                                               sudo ln -sf ${SWIFT_CONFIG_DIR} /etc/swift
                                                                                                                                                                                                                                                                                                                                                                                                   fi
                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                       # Swift use rsync to syncronize between all the different
                                                                                                                                                                                                                                                                                                                                                                                                           # partitions (which make more sense when you have a multi-node
                                                                                                                                                                                                                                                                                                                                                                                                               # setup) we configure it with our version of rsync.
                                                                                                                                                                                                                                                                                                                                                                                                                   sed -e "
                                                                                                                                                                                                                                                                                                                                                                                                                           s/%GROUP%/${USER_GROUP}/;
                                                                                                                                                                                                                                                                                                                                                                                                                                   s/%USER%/$USER/;
                                                                                                                                                                                                                                                                                                                                                                                                                                           s,%SWIFT_DATA_DIR%,$SWIFT_DATA_DIR,;
                                                                                                                                                                                                                                                                                                                                                                                                                                               " $FILES/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
                                                                                                                                                                                                                                                                                                                                                                                                                                                  sudo sed -i '/^RSYNC_ENABLE=false/ { s/false/true/ }' /etc/default/rsync
                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                     # By default Swift will be installed with the tempauth middleware
                                                                                                                                                                                                                                                                                                                                                                                                                                                        # which has some default username and password if you have
                                                                                                                                                                                                                                                                                                                                                                                                                                                           # configured keystone it will checkout the directory.
                                                                                                                                                                                                                                                                                                                                                                                                                                                              if is_service_enabled key; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     swift_auth_server="s3token authtoken keystone"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               swift_auth_server=tempauth
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # We do the install of the proxy-server and swift configuration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # replacing a few directives to match our configuration.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           sed -e "
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  s,%SWIFT_CONFIG_DIR%,${SWIFT_CONFIG_DIR},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         s,%USER%,$USER,g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       s,%SERVICE_USERNAME%,swift,g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              s,%SERVICE_PASSWORD%,$SERVICE_PASSWORD,g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     s,%KEYSTONE_SERVICE_PROTOCOL%,$KEYSTONE_SERVICE_PROTOCOL,g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s,%SERVICE_TOKEN%,${SERVICE_TOKEN},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   s,%KEYSTONE_SERVICE_PORT%,${KEYSTONE_SERVICE_PORT},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          s,%KEYSTONE_SERVICE_HOST%,${KEYSTONE_SERVICE_HOST},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 s,%KEYSTONE_API_PORT%,${KEYSTONE_API_PORT},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        s,%KEYSTONE_AUTH_HOST%,${KEYSTONE_AUTH_HOST},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               s,%KEYSTONE_AUTH_PORT%,${KEYSTONE_AUTH_PORT},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      s,%KEYSTONE_AUTH_PROTOCOL%,${KEYSTONE_AUTH_PROTOCOL},g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             s/%AUTH_SERVER%/${swift_auth_server}/g;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 " $FILES/swift/proxy-server.conf | \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sudo tee ${SWIFT_CONFIG_DIR}/proxy-server.conf
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sed -e "s/%SWIFT_HASH%/$SWIFT_HASH/" $FILES/swift/swift.conf > ${SWIFT_CONFIG_DIR}/swift.conf
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # We need to generate a object/account/proxy configuration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # emulating 4 nodes on different ports we have a little function
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # that help us doing that.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function generate_swift_configuration() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    local server_type=$1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            local bind_port=$2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    local log_facility=$3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            local node_number
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for node_number in $(seq ${SWIFT_REPLICAS}); do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                node_path=${SWIFT_DATA_DIR}/${node_number}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sed -e "
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s,%SWIFT_CONFIG_DIR%,${SWIFT_CONFIG_DIR},;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s,%USER%,$USER,;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s,%NODE_PATH%,${node_path},;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s,%BIND_PORT%,${bind_port},;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            s,%LOG_FACILITY%,${log_facility},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        " $FILES/swift/${server_type}-server.conf > ${SWIFT_CONFIG_DIR}/${server_type}-server/${node_number}.conf
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    bind_port=$(( ${bind_port} + 10 ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                log_facility=$(( ${log_facility} + 1 ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                generate_swift_configuration object 6010 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    generate_swift_configuration container 6011 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        generate_swift_configuration account 6012 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # We have some specific configuration for swift for rsyslog. See
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # the file /etc/rsyslog.d/10-swift.conf for more info.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 swift_log_dir=${SWIFT_DATA_DIR}/logs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    rm -rf ${swift_log_dir}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       mkdir -p ${swift_log_dir}/hourly
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          sudo chown -R syslog:adm ${swift_log_dir}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             sed "s,%SWIFT_LOGDIR%,${swift_log_dir}," $FILES/swift/rsyslog.conf | sudo \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tee /etc/rsyslog.d/10-swift.conf
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       sudo restart rsyslog
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # This is where we create three different rings for swift with
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # different object servers binding on different ports.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pushd ${SWIFT_CONFIG_DIR} >/dev/null && {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              port_number=6010
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     swift-ring-builder object.builder create ${SWIFT_PARTITION_POWER_SIZE} ${SWIFT_REPLICAS} 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for x in $(seq ${SWIFT_REPLICAS}); do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       swift-ring-builder object.builder add z${x}-127.0.0.1:${port_number}/sdb1 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  port_number=$[port_number + 10]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                swift-ring-builder object.builder rebalance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       port_number=6011
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              swift-ring-builder container.builder create ${SWIFT_PARTITION_POWER_SIZE} ${SWIFT_REPLICAS} 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     for x in $(seq ${SWIFT_REPLICAS}); do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                swift-ring-builder container.builder add z${x}-127.0.0.1:${port_number}/sdb1 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           port_number=$[port_number + 10]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         swift-ring-builder container.builder rebalance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                port_number=6012
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       swift-ring-builder account.builder create ${SWIFT_PARTITION_POWER_SIZE} ${SWIFT_REPLICAS} 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              for x in $(seq ${SWIFT_REPLICAS}); do
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         swift-ring-builder account.builder add z${x}-127.0.0.1:${port_number}/sdb1 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    port_number=$[port_number + 10]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  swift-ring-builder account.builder rebalance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } && popd >/dev/null
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sudo chmod +x /usr/local/bin/swift-*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # We then can start rsync.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sudo /etc/init.d/rsync restart || :
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # First spawn all the swift services then kill the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # proxy service so we can run it in foreground in screen.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # ``swift-init ... {stop|restart}`` exits with '1' if no servers are running,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # ignore it just in case
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             swift-init all restart || true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                swift-init proxy stop || true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   unset s swift_hash swift_auth_server
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   